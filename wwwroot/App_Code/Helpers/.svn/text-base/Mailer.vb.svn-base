Imports Microsoft.VisualBasic
Imports Orbelink.DBHandler
Imports System.IO

Namespace Orbelink.Helpers
    Public Module Mailer

        Public Const Replace_Correos_Envio As String = "THE_ID_CORREOS_ENVIO"
        Public Const Replace_Nombre_Envio As String = "USUARIO DEL NEWSLETTER"

        Public Enum StatusEnvio As Integer
            ENVIADO = 0
            VISTO = 1
            RECHAZADO = 2
            ESPERA = 3
            NO_ENVIADO = 4
        End Enum

        Public Enum TipoEnvio As Integer
            ENVIO = 0
            RAPIDO = 1
            IMAGEN = 2
        End Enum

        Public Function SendOneMail(ByVal From_Email As String, ByVal From_Name As String, ByVal To_Email As String, ByVal To_Name As String, _
                ByVal Subject As String, ByVal Body As String) As Boolean
            Dim enviado As Boolean
            Try
                Dim client As New System.Net.Mail.SmtpClient()
                Dim mailTo As New System.Net.Mail.MailAddress(To_Email, To_Name)
                Dim correo As New System.Net.Mail.MailMessage()

                If From_Email IsNot Nothing Then
                    Dim mailReplyTo As New System.Net.Mail.MailAddress(From_Email, From_Name)
                    correo.ReplyTo = mailReplyTo
                End If

                correo.To.Add(mailTo)
                correo.IsBodyHtml = True
                correo.Subject = Subject
                correo.Body = Body
                client.Port = 25
                client.Send(correo)
                enviado = True
            Catch exc As Exception
                enviado = False
            End Try

            Return enviado
        End Function

        Public Function SendPasswordRecovery(ByVal To_Email As String, ByVal To_Name As String, _
                ByVal Username As String, ByVal Password As String, ByVal SiteName As String, ByVal SiteURL As String) As Boolean
            Dim body As String = "<h1>Recuperar su password para " & SiteName & "</h1><br><br>"
            body &= "Este es un email autogenerado porque usted ha olvidado su password.<br><br>"
            body &= "Su informacion es:<br>"
            body &= "  - Username: " & Username & "<br>"
            body &= "  - Password:  " & Password & "<br>"
            body &= "<br><br>Puede entrar a " & SiteName & " en "
            body &= "<a href=""" & SiteURL & """ >" & SiteURL & "</a><br>"

            Return SendOneMail(Nothing, Nothing, To_Email, To_Name, "Recuperar su password para " & SiteName, body)
        End Function

        Public Function SendPendienteUpdated(ByVal To_Email As String, ByVal To_Name As String, ByVal Pendiente_Nombre As String, _
                     ByVal Name As String, ByVal Status As String, ByVal Comment As String, _
                     ByVal SiteName As String, ByVal SiteURL As String) As Boolean
            Dim body As String = "This is an autogenerated email to inform you of a change on your " & Pendiente_Nombre & "<br><br>"
            body &= "Your information is:<br>"
            body &= "  - Name: " & Name & "<br>"
            body &= "  - Status:  " & Status & "<br>"
            body &= "  - Comment:  " & Comment & "<br>"
            body &= "<br><br>View it at <a href=""" & SiteURL & """ >" & SiteURL & "</a><br>"

            Return SendOneMail(Nothing, Nothing, To_Email, To_Name, "Actualizacion de pendiente en " & SiteName, body)
        End Function

        Public Function SendOneMail_Authenticate(ByVal From_Email As String, ByVal From_Name As String, ByVal To_Email As String, ByVal To_Name As String, _
                ByVal ReplyTo_Email As String, ByVal ReplyTo_Name As String, ByVal Subject As String, ByVal Body As String, ByVal SMTPServer As String, ByVal Username As String, ByVal Password As String) As Boolean
            Dim enviado As Boolean
            Try
                Dim client As New System.Net.Mail.SmtpClient(SMTPServer)
                Dim mailReplyTo As New System.Net.Mail.MailAddress(ReplyTo_Email, ReplyTo_Name)
                Dim mailFrom As New System.Net.Mail.MailAddress(From_Email, From_Name)
                Dim mailTo As New System.Net.Mail.MailAddress(To_Email, To_Name)
                Dim correo As New System.Net.Mail.MailMessage(mailFrom, mailTo)

                correo.IsBodyHtml = True
                correo.Subject = Subject
                correo.Body = Body
                correo.ReplyTo = mailReplyTo

                client.Credentials = New System.Net.NetworkCredential(Username, Password)
                client.Port = 25
                client.Send(correo)

                enviado = True
            Catch exc As Exception
                enviado = False
            End Try

            Return enviado
        End Function

        Public Function AuthenticateSMTPServer(ByVal From_Email As String, ByVal From_Name As String, ByVal ServerName As String, ByVal SMTPUserName As String, ByVal SMTPPassword As String) As Boolean
            Dim valido As Boolean = False

            If ServerName.Length > 0 And SMTPUserName.Length > 0 And SMTPPassword.Length > 0 Then
                If Orbelink.Helpers.Mailer.SendOneMail_Authenticate(From_Email, From_Name, "mailer@tambormanager.com", "Authentication Test Mail", "mailer@tambormanager.com", "Authentication Test Mail", "Authentication Test", "Authentication Test", ServerName, SMTPUserName, SMTPPassword) Then
                    valido = True
                End If
            End If

            Return valido
        End Function

        Public Function RequestContent_ByURL(ByVal url As String) As String
            Dim contenido As String = ""
            Dim myHttpWebRequest As System.Net.HttpWebRequest = System.Net.HttpWebRequest.Create(url)
            Dim myHttpWebResponse As System.Net.HttpWebResponse = myHttpWebRequest.GetResponse()

            Dim receiveStream As Stream = myHttpWebResponse.GetResponseStream()
            Dim encode As Encoding = System.Text.Encoding.GetEncoding("utf-8")
            Dim readStream As New StreamReader(receiveStream, encode)

            contenido = readStream.ReadToEnd()

            readStream.Close()
            myHttpWebResponse.Close()
            Return contenido
        End Function

        Public Sub SendMeetRequest()
            'INITIALIZING MEETING DETAILS

            Dim schLocation As String = "Conference Room"
            Dim schSubject As String = "Business visit discussion"
            Dim schDescription As String = "Schedule description"
            Dim schBeginDate As Date = Convert.ToDateTime("9/3/2008 10:00:00 PM")
            Dim schEndDate As Date = Convert.ToDateTime("9/3/2008 11:00:00 PM")

            'Meeting
            Dim attende As New Orbelink.Calendar.VAttendee("Kenito", "kvalenciano@orbelink.com", Orbelink.Calendar.VAttendee.Participation.NEEDS_ACTION)

            Dim evento As New Orbelink.Calendar.VEvent(Date.UtcNow, Date.UtcNow.AddHours(1), Date.UtcNow.AddHours(2), "Kenneth", "kvalenciano@orbelink.com", "San Jose, Costa Rica", "Prueba", "Algun texto ahi")
            evento.VAttendeeCollection.Add(attende)

            Dim calendar As New Orbelink.Calendar.VCalendar
            calendar.VEventCollection.Add(evento)

            'Mail
            Dim mailMessage As New System.Net.Mail.MailMessage()
            mailMessage.From = New System.Net.Mail.MailAddress("kvalenciano@orbelink.com", "Yo")
            mailMessage.To.Add(New System.Net.Mail.MailAddress("kvalenciano@orbelink.com", "Yo"))
            mailMessage.Subject = "Outlook calendar as attachment"
            mailMessage.Body = "This is a test message."

            'MAKE AN ATTACHMENT 
            Directory.CreateDirectory(Configuration.outPath & "ics\")
            Dim nombreArchivo As String = Configuration.outPath & "ics\" & Date.UtcNow.ToString("yyyy-MM-dd_HH-mm-ss") & ".ics"

            Dim stream As New StreamWriter(nombreArchivo)
            calendar.Render(stream)
            stream.Close()

            Dim mailAttachment As New System.Net.Mail.Attachment(nombreArchivo)
            mailMessage.Attachments.Add(mailAttachment)

            Dim smtp As New System.Net.Mail.SmtpClient("mail.orbelink.com")
            smtp.Credentials = New System.Net.NetworkCredential("kvalenciano@orbelink.com", "12345")
            smtp.Send(mailMessage)
        End Sub

    End Module

End Namespace